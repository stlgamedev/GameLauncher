name: Build and Release Windows Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (branch or tag) to build'
        required: true
        default: 'main'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.ref }}

      # Install Haxe
      - name: Install Haxe
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: 4.3.3

      # Install dependencies
      - name: Install haxelibs
        run: |
          haxelib install hxcpp
          haxelib install openfl
          haxelib install flixel
          haxelib install openfl-aseprite
          haxelib install hxcodec

      # Sync version from Project.xml to STLGameLauncher.iss
      - name: Sync version to .iss
        run: python scripts/update_iss_version.py Project.xml STLGameLauncher.iss

      # Build Windows executable
      - name: Build Windows Executable
        run: haxelib run lime build windows -release -final

      # Install Inno Setup
      - name: Install Inno Setup
        run: choco install innosetup

      # Build installer
      - name: Build Installer
        run: ISCC.exe STLGameLauncher.iss

      # Find the installer exe
      - name: Find installer
        id: find_installer
        run: |
          $file = Get-ChildItem -Path Builds -Filter *.exe | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          echo "INSTALLER_PATH=$($file.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append

      # Upload to GitHub Releases
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.INSTALLER_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download WinSCP Portable
        run: |
          Invoke-WebRequest -Uri "https://winscp.net/download/WinSCP-6.3.3-Portable.zip" -OutFile "WinSCP.zip"
          Expand-Archive WinSCP.zip -DestinationPath WinSCP
      
      - name: Prepare WinSCP Script
        run: |
          $script = @"
          option batch abort
          option confirm off
          open sftp://${{ secrets.SFTP_USER }}:${{ secrets.SFTP_PASSWORD }}@${{ secrets.SFTP_HOST }}
          rm /home/public/STLGameLauncher-Setup-*.exe
          put ""${{ env.INSTALLER_PATH }}"" /home/public/
          exit
          "@
          $script | Set-Content -Path deploy_script.txt
      
      - name: Deploy installer with WinSCP
        run: |
          .\WinSCP\WinSCP.com /script=deploy_script.txt
